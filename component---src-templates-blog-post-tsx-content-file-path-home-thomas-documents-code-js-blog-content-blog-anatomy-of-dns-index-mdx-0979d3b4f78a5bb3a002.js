"use strict";(self.webpackChunkgatsby_starter_blog=self.webpackChunkgatsby_starter_blog||[]).push([[949],{1046:function(e,t,n){n.d(t,{w_:function(){return c}});var a=n(7294),r={color:void 0,size:void 0,className:void 0,style:void 0,attr:void 0},l=a.createContext&&a.createContext(r),o=function(){return o=Object.assign||function(e){for(var t,n=1,a=arguments.length;n<a;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},o.apply(this,arguments)},i=function(e,t){var n={};for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&t.indexOf(a)<0&&(n[a]=e[a]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(a=Object.getOwnPropertySymbols(e);r<a.length;r++)t.indexOf(a[r])<0&&Object.prototype.propertyIsEnumerable.call(e,a[r])&&(n[a[r]]=e[a[r]])}return n};function s(e){return e&&e.map((function(e,t){return a.createElement(e.tag,o({key:t},e.attr),s(e.child))}))}function c(e){return function(t){return a.createElement(u,o({attr:o({},e.attr)},t),s(e.child))}}function u(e){var t=function(t){var n,r=e.attr,l=e.size,s=e.title,c=i(e,["attr","size","title"]),u=l||t.size||"1em";return t.className&&(n=t.className),e.className&&(n=(n?n+" ":"")+e.className),a.createElement("svg",o({stroke:"currentColor",fill:"currentColor",strokeWidth:"0"},t.attr,r,c,{className:n,style:o(o({color:e.color||t.color},t.style),e.style),height:u,width:u,xmlns:"http://www.w3.org/2000/svg"}),s&&a.createElement("title",null,s),e.children)};return void 0!==l?a.createElement(l.Consumer,null,(function(e){return t(e)})):t(r)}},3483:function(e,t,n){n.r(t),n.d(t,{Head:function(){return g},default:function(){return b}});n(935);var a=n(6410),r=n(7294),l=n(3079),o=n(1862);function i(e){var t=Object.assign({p:"p",a:"a",div:"div",h2:"h2",em:"em",code:"code",pre:"pre",strong:"strong",h3:"h3",h1:"h1"},(0,a.ah)(),e.components);return r.createElement(r.Fragment,null,r.createElement(t.p,null,"I like to just randomly spend my time on the internet, and every once in a while\ni stumble upon interesting blog posts. I have for a very long time considered\nmyself really bad at everything related to networking."),"\n",r.createElement(t.p,null,"I found this blog post about how you would go about to write a DNS client. I just\nglanced through it without looking at any implementations, and then decided to\nlook up the RFC and suddenly had this feeling that… i could write a client myself."),"\n",r.createElement(t.p,null,"Julia Evans at ",r.createElement(t.a,{href:"https://wizardzines.com/comics/dns-packet/"},"wizard zines")," makes\nthese amazing comics and she had this image that showed what a DNS\nrequest/response looked like and it looked so simple."),"\n",r.createElement(t.p,null,r.createElement(t.div,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/c0bc94b659686e9aa955363c492f9951/b4098/dns-packet.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 64.55696202531645%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACX0lEQVQ4y22T6XKkMAyE8/4Pl2zVTI65J4HhxtgD+MDAt2tPsvtnVeUSNrKsbrWeyrKkKAqu1yvGGKSUdF1H0zQIIRjHEaVU3LdtS9/3MTZ8D8MQfYi73+8EewoX3t/fORwOaK1JkoTn5+e4Pj4+or9cLry9vXE+nzmdTry8vES/3W55fX1lu32lrutHQv5jy7xgjcV7HysM+3VZmb1nnn2MCf+sdcCK9xPrsjwSBphZlhGgV1WFkhLjHXqy5KolvwsaKeh6hXEzxi2MxlN1jlulEXLE+RVtF+Z5+Qd5u93w+fngUQyKrCzQ6o6qW8q6Iq9KxGBp2w4hOsZaUlcNaZo+OO4GJr88IIfDX5sPztcbgzaxot1+T5Fl3JWMCL5uCb311FVFknxxlyLCrm4Jl9OB8zXBzytP0zRxPB5Js4LjOaFKbxRNyf6wJ88y6qrGTxPaWZR28Sw08JakdK3ATRPzPKPt/KgwyCB0L5jTIzr/YrCapm1ZeoNuJN463OzpBhuVIOoGrMeNmjzPcc5ip+Uf5B9b1zV67R21aMiLnLzMSbIUNfYMZo58ZbcbY6dwg8Zay7zMaOMfCZdlwTkXxfnT6SDStm44HI98Xq+czidGrTFu/SvmSQ54YxGy4/204zPNHxyGF3e7XeQxCHmz2cSkgduoyWX5u4I0QnxoYnNJadIc0QryukSEB0LCUHIYtTAhYRqCDxWEDv4oIIzaLcto5UBR5BwOe5SS9EphjEbJDm2/IQfeQpdCgkD48q34Hz7Dg6Fx1hpGM9OIgbKW9ONErz2D9vR6QvYT/o+wfwPJJdwIvbPm6wAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="DNS packet"\n        title="DNS packet"\n        src="/static/c0bc94b659686e9aa955363c492f9951/f058b/dns-packet.png"\n        srcset="/static/c0bc94b659686e9aa955363c492f9951/c26ae/dns-packet.png 158w,\n/static/c0bc94b659686e9aa955363c492f9951/6bdcf/dns-packet.png 315w,\n/static/c0bc94b659686e9aa955363c492f9951/f058b/dns-packet.png 630w,\n/static/c0bc94b659686e9aa955363c492f9951/b4098/dns-packet.png 816w"\n        sizes="(max-width: 630px) 100vw, 630px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}})),"\n",r.createElement(t.p,null,"So in this blog posts and maybe some additional blog posts i will write about\nall the things i learnt during the development of my dns client ",r.createElement(t.a,{href:"https://github.com/Tandolf/who"},"Who are\nyou?")," written in rust. Some thing might be\nspecification related related, and others might be coding/implementation\nrelated. For instance how i solved certain problems in code."),"\n",r.createElement(t.h2,null,"What is DNS (Domain Name System)?"),"\n",r.createElement(t.p,null,"Like i usually do, i start out with the wikipedia explanation."),"\n",r.createElement(l.Z,{source:"wikipedia"},r.createElement(t.p,null,"The Domain Name System (DNS) is a hierarchical and distributed naming system for\ncomputers, services, and other resources … it translates readily memorized\ndomain names to the numerical IP addresses needed for locating and identifying\ncomputer services and devices with the underlying network protocols.")),"\n",r.createElement(t.p,null,"The short explanation is that the internet has no idea what web addresses are,\nthe internet works with ip addresses. So all over the internet there are DNS\nservers that you can query with a domain name and get an ip-address back instead.\nSo think of DNS-servers as sort of old school phonebooks."),"\n",r.createElement(t.p,null,"The original DNS specification is defined in the ",r.createElement(t.a,{href:"https://datatracker.ietf.org/doc/html/rfc1035"},"rfc 1035"),", and we are going to reference that throughout this post."),"\n",r.createElement(t.p,null,"There has been significate updates of the DNS protocol throughout the years. Especially with the addition of ",r.createElement(t.em,null,"DNSSEC")," which currently is defined by ",r.createElement(t.a,{href:"https://datatracker.ietf.org/doc/html/rfc4033"},"rfc 4033"),", ",r.createElement(t.a,{href:"https://datatracker.ietf.org/doc/html/rfc4034"},"rfc4034")," and ",r.createElement(t.a,{href:"https://datatracker.ietf.org/doc/html/rfc4035"},"rfc4035"),". ",r.createElement(t.em,null,"DNSSEC")," wont be covered in this post as it is a big topic."),"\n",r.createElement(t.h2,null,"Lets make a DNS Request"),"\n",r.createElement(t.p,null,"So in order to make a dns request there are several different dns clients out\nthere. Im going to use the program ",r.createElement(t.code,null,"dig")," but there are others like ",r.createElement(t.code,null,"nslookup"),"\netc."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-bash"},"➜  ~ dig blog.toerktumlare.com\n\n; <<>> DiG 9.18.18-0ubuntu0.22.04.1-Ubuntu <<>> blog.toerktumlare.com\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 40955\n;; flags: qr rd ra; QUERY: 1, ANSWER: 5, AUTHORITY: 0, ADDITIONAL: 1\n\n;; OPT PSEUDOSECTION:\n; EDNS: version: 0, flags:; udp: 65494\n;; QUESTION SECTION:\n;blog.toerktumlare.com.\t\tIN\tA\n\n;; ANSWER SECTION:\nblog.toerktumlare.com.\t3600\tIN\tCNAME\ttandolf.github.io.\ntandolf.github.io.\t3600\tIN\tA\t185.199.108.153\ntandolf.github.io.\t3600\tIN\tA\t185.199.109.153\ntandolf.github.io.\t3600\tIN\tA\t185.199.110.153\ntandolf.github.io.\t3600\tIN\tA\t185.199.111.153\n\n;; Query time: 59 msec\n;; SERVER: 127.0.0.53#53(127.0.0.53) (UDP)\n;; WHEN: Sat Nov 11 18:38:37 CET 2023\n;; MSG SIZE  rcvd: 145\n")),"\n",r.createElement(t.p,null,"So a simple DNS request on this blog returns the above information. There is a\nlot of information returned, but what does the ",r.createElement(t.em,null,"actual")," request and response\nlook like."),"\n",r.createElement("br"),"\n",r.createElement("br"),"\n",r.createElement("br"),"\n",r.createElement("br"),"\n",r.createElement(t.p,null,"If we run ",r.createElement(t.code,null,"tcpdump")," and sniff the traffic we get the following."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-bash"},"➜  ~ sudo tcpdump --interface any -n port 53 -X\ntcpdump: data link type LINUX_SLL2\ntcpdump: verbose output suppressed, use -v[v]... for full protocol decode\nlistening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes\n18:49:49.939297 lo    In  IP 127.0.0.1.38500 > 127.0.0.53.53: 39085+ [1au] A? blog.toerktumlare.com. (62)\n\t0x0000:  4500 005a c2c1 0000 4011 b99b 7f00 0001  E..Z....@.......\n\t0x0010:  7f00 0035 9664 0035 0046 fe8d 98ad 0120  ...5.d.5.F......\n\t0x0020:  0001 0000 0000 0000 0462 6c6f 670c 746f  .........blog.to\n\t0x0030:  6572 6b74 756d 6c61 7265 0363 6f6d 0000  erktumlare.com..\n\t0x0040:  0100 0100 0029 04d0 0000 0000 000c 000a  .....)..........\n\t0x0050:  0008 e157 ecab eb0d 51bd                 ...W....Q.\n18:49:49.939588 lo    In  IP 127.0.0.53.53 > 127.0.0.1.38500: 39085 5/0/1 CNAME tandolf.github.io., A 185.199.108.153, A 185.199.110.153, A 185.199.109.153, A 185.199.111.153 (145)\n\t0x0000:  4500 00ad 8a61 4000 0111 f0a8 7f00 0035  E....a@........5\n\t0x0010:  7f00 0001 0035 9664 0099 fee0 98ad 8180  .....5.d........\n\t0x0020:  0001 0005 0000 0001 0462 6c6f 670c 746f  .........blog.to\n\t0x0030:  6572 6b74 756d 6c61 7265 0363 6f6d 0000  erktumlare.com..\n\t0x0040:  0100 01c0 0c00 0500 0100 000b 6f00 1307  ............o...\n\t0x0050:  7461 6e64 6f6c 6606 6769 7468 7562 0269  tandolf.github.i\n\t0x0060:  6f00 c033 0001 0001 0000 0b6f 0004 b9c7  o..3.......o....\n\t0x0070:  6c99 c033 0001 0001 0000 0b6f 0004 b9c7  l..3.......o....\n\t0x0080:  6e99 c033 0001 0001 0000 0b6f 0004 b9c7  n..3.......o....\n\t0x0090:  6d99 c033 0001 0001 0000 0b6f 0004 b9c7  m..3.......o....\n\t0x00a0:  6f99 0000 29ff d600 0000 0000 00         o...)........\n^C\n2 packets captured\n4 packets received by filter\n0 packets dropped by kernel\n")),"\n",r.createElement(t.p,null,"This is once again a lot of information. The first chunk, is the actual query.\nWhile the second part is the response from the dns server."),"\n",r.createElement("br"),"\n",r.createElement("br"),"\n",r.createElement("br"),"\n",r.createElement("br"),"\n",r.createElement(t.p,null,"So if we isolate just the query:"),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-bash"},"18:49:49.939297 lo    In  IP 127.0.0.1.38500 > 127.0.0.53.53: 39085+ [1au] A? blog.toerktumlare.com. (62)\n\t0x0000:  4500 005a c2c1 0000 4011 b99b 7f00 0001  E..Z....@.......\n\t0x0010:  7f00 0035 9664 0035 0046 fe8d 98ad 0120  ...5.d.5.F......\n\t0x0020:  0001 0000 0000 0000 0462 6c6f 670c 746f  .........blog.to\n\t0x0030:  6572 6b74 756d 6c61 7265 0363 6f6d 0000  erktumlare.com..\n\t0x0040:  0100 0100 0029 04d0 0000 0000 000c 000a  .....)..........\n\t0x0050:  0008 e157 ecab eb0d 51bd                 ...W....Q.\n")),"\n",r.createElement(t.p,null,"We see that there is some text and just a bunch of different hex numbers. Out of\nall these hex numbers we need first start to discard all the things we don’t\nneed. The first ",r.createElement(t.code,null,"20 bytes")," is the ipv4 header so we can discard that."),"\n",r.createElement(t.p,null,"The ipv4 header:"),"\n",r.createElement(t.pre,null,r.createElement(t.code,null,"  4500 005a c2c1 0000 4011 b99b 7f00 0001 7f00 0035\n")),"\n",r.createElement(t.p,null,"The next ",r.createElement(t.code,null,"8 bytes")," after that is the ",r.createElement(t.em,null,"UDP Header"),". And already we learnt\nsomething, and that is that ",r.createElement(t.strong,null,"DNS is sent over UDP"),". You have to remember that the\noriginal DNS specification is from November 1987, it was in the early days of\nthe internet."),"\n",r.createElement(t.p,null,"The UDP header:"),"\n",r.createElement(t.pre,null,r.createElement(t.code,null,"  9664 0035 0046 fe8d \n")),"\n",r.createElement(t.p,null,"Its worth noting that the specification has been updated several times, and that\nyou can in fact send DNS over TCP (most DNS resolvers will accept it) and that DNSSec\nhas also been introduced which adds a lot of security features to the protocol."),"\n",r.createElement("br"),"\n",r.createElement("br"),"\n",r.createElement("br"),"\n",r.createElement("br"),"\n",r.createElement(t.p,null,"So what we are left with is:"),"\n",r.createElement(t.pre,null,r.createElement(t.code,null,"  98ad 0120 0001 0000 0000 0001 0462 6c6f 670c 746f \n  6572 6b74 756d 6c61 7265 0363 6f6d 0000 0100 0100 \n  0029 04d0 0000 0000 000c 000a 0008 e157 ecab eb0d \n  51bd\n")),"\n",r.createElement(t.p,null,"And this ladies and gentlemen is our raw dns request!"),"\n",r.createElement(t.h2,null,"Anatomy of a DNS message"),"\n",r.createElement(t.p,null,"So i think it is about time that we pull up the official dns specification and\nif we look in the ",r.createElement(t.em,null,"message")," section of the rfc, they have a very nice image\nrepresentation of what a single dns message looks like. So all in all a DNS\nmessages, both requests and responses, has the following general structure."),"\n",r.createElement(t.pre,null,r.createElement(t.code,null,"    +---------------------+\n    |        Header       |\n    +---------------------+\n    |       Question      | the question for the name server\n    +---------------------+\n    |        Answer       | RRs answering the question\n    +---------------------+\n    |      Authority      | RRs pointing toward an authority\n    +---------------------+\n    |      Additional     | RRs holding additional information\n    +---------------------+\n")),"\n",r.createElement(t.p,null,"One of the things we are going to see later is that the Header and the Question\nis always going to be in the message and the responses, but depending on what\nresponse we get back the last three sections of the message will differ."),"\n",r.createElement(t.h2,null,"The DNS Header"),"\n",r.createElement(t.p,null,"So we are going to start out with the header, and an image usually says more\nthan a 1000 words so we are going to extract an image (once again) ",r.createElement(t.a,{href:"https://datatracker.ietf.org/doc/html/rfc1035#section-4.1.1"},"rfc\n1035")," that shows\nthe overall structure of the header section."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-bash"},"                                    1  1  1  1  1  1\n      0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5\n    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n    |                      ID                       |\n    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n    |QR|   Opcode  |AA|TC|RD|RA|   Z    |   RCODE   |\n    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n    |                    QDCOUNT                    |\n    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n    |                    ANCOUNT                    |\n    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n    |                    NSCOUNT                    |\n    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n    |                    ARCOUNT                    |\n    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n")),"\n",r.createElement(t.p,null,"A DNS header is always ",r.createElement(t.strong,null,"12 bytes long")," and contains all the metadata for the\nmessage. This includes both information that has to do with the request, but\nalso information about the response, since a DNS message is actually both."),"\n",r.createElement(t.h2,null,"Id"),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-bash"},"      0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5\n    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n    |                      ID                       |\n    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n")),"\n",r.createElement(t.p,null,"A 16 bit identifier assigned by the program that generates the query.  This\nidentifier is copied over to the corresponding reply and can be used by the\nrequester to match up replies to outstanding queries. So if you make a lot of\nrequests, this id ccan help you match up what request to its corresponding\nresponse. For instance in a async environment."),"\n",r.createElement(t.p,null,"Our first 2 bytes have the hex number ",r.createElement(t.code,null,"98ad"),", which converted to decimal is\n",r.createElement(t.code,null,"39085")," so that is our id for this request."),"\n",r.createElement(t.h2,null,"Flags"),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-bash"},"      0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5\n    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n    |QR|   Opcode  |AA|TC|RD|RA|   Z    |   RCODE   |\n    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n")),"\n",r.createElement(t.p,null,"Several different flags that will for instance define what type of DNS message\nthis is or provide instructions to the server of how you want it to process your\nrequest. This header will also contain a response code that will tell us of the\noutcome of the request (if there was an error or not etc.)."),"\n",r.createElement("br"),"\n",r.createElement("br"),"\n",r.createElement("br"),"\n",r.createElement("br"),"\n",r.createElement(t.p,null,"Lets go through all the flags one by one."),"\n",r.createElement(t.h3,null,"- QR (Query/Response)"),"\n",r.createElement(t.p,null,"A one bit field that specifies whether this message is a query (0), or a\nresponse (1)."),"\n",r.createElement(t.h3,null,"- OPCODE (Operation Code)"),"\n",r.createElement(t.p,null,"A four bit field that specifies what kind of query this message is. This value\nis set by the originator of a query and copied into the response. The values\nare:"),"\n",r.createElement(t.p,null,"        0               a standard query (QUERY)"),"\n",r.createElement(t.p,null,"        1               an inverse query (IQUERY)"),"\n",r.createElement(t.p,null,"        2               a server status request (STATUS)"),"\n",r.createElement(t.p,null,"        3-15            reserved for future use"),"\n",r.createElement(t.h3,null,"- AA (Authoritative Answer)"),"\n",r.createElement(t.p,null,"this bit is valid in responses, and specifies if the responding name server is\nan authority for the domain name we are asking about. Basically it denotes\nif the name server we asked has ",r.createElement(t.em,null,"responsibility")," over the domain."),"\n",r.createElement(t.p,null,"Note that the contents of the answer section may have multiple owners because of\naliases. This AA bit corresponds to the name which matches the query name."),"\n",r.createElement(t.h3,null,"- TC (TrunCation)"),"\n",r.createElement(t.p,null,"Specifies that this message was truncated due to length greater than that\npermitted on the transmission channel (so basically if this message was too long)."),"\n",r.createElement(t.h3,null,"- RD (Recursion Desired)"),"\n",r.createElement(t.p,null,"This bit can be set in a query and is copied into the response. If RD is set, it\ndirects the name server to pursue the query recursively. So if the name server\nim asking doesn’t know what the IP-address is for the domain i’m querying about,\nim telling the name server to start asking around to other name servers until it\nfins one that does know. This bit is usually always set, but there are some\nuser cases when you don’t want to do recursive lookups."),"\n",r.createElement(t.h3,null,"- RA (Recursion Available)"),"\n",r.createElement(t.p,null,"This be is set or cleared in a response, and denotes whether recursive query\nsupport is available in the name server."),"\n",r.createElement(t.h3,null,"- Z"),"\n",r.createElement(t.p,null,"Reserved for future use.  Must be zero in all queries and responses."),"\n",r.createElement(t.h3,null,"- RCODE (Response Code)"),"\n",r.createElement(t.p,null,"Response code - this 4 bit field is set as part of responses.  The values have\nthe following interpretation:"),"\n",r.createElement(t.p,null,"0. ",r.createElement(t.strong,null,"No error condition")),"\n",r.createElement(t.p,null,"1. ",r.createElement(t.strong,null,"Format error")," - The name server was unable to interpret the query."),"\n",r.createElement(t.p,null,"2. ",r.createElement(t.strong,null,"Server failure")," - The name server was unable to process this query due to\na problem with the name server."),"\n",r.createElement(t.p,null,"3. ",r.createElement(t.strong,null,"Name Error")," - Meaningful only for responses from an authoritative name server, this code\nsignifies that the domain name referenced in the query does not exist."),"\n",r.createElement(t.p,null,"4. ",r.createElement(t.strong,null,"Not Implemented")," - The name server does not support the requested kind of query."),"\n",r.createElement(t.p,null,"5. ",r.createElement(t.strong,null,"Refused")," - The name server refuses to perform the specified operation for policy\nreasons. For example, a name server may not wish to provide the information to the\nparticular requester, or a name server may not wish to perform a particular\noperation (e.g., zone transfer) for particular data."),"\n",r.createElement(t.p,null,"6-15. ",r.createElement(t.strong,null,"Reserved for future use")),"\n",r.createElement(t.h2,null,"Count Section"),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-bash"},"      0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5\n    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n    |                    QDCOUNT                    |\n    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n    |                    ANCOUNT                    |\n    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n    |                    NSCOUNT                    |\n    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n    |                    ARCOUNT                    |\n    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n")),"\n",r.createElement(t.h3,null,"QDCOUNT (Questions Defined)"),"\n",r.createElement(t.p,null,"an unsigned 16 bit integer specifying the number of entries in the question\nsection."),"\n",r.createElement(t.h3,null,"ANCOUNT (Answers)"),"\n",r.createElement(t.p,null,"an unsigned 16 bit integer specifying the number of resource records in the\nanswer section."),"\n",r.createElement(t.h3,null,"NSCOUNT (Name Servers)"),"\n",r.createElement(t.p,null,"an unsigned 16 bit integer specifying the number of name server resource records\nin the authority records section."),"\n",r.createElement(t.h3,null,"ARCOUNT (Additional Record)"),"\n",r.createElement(t.p,null,"an unsigned 16 bit integer specifying the number of resource records in the\nadditional records section."),"\n",r.createElement("br"),"\n",r.createElement("br"),"\n",r.createElement("br"),"\n",r.createElement(t.p,null,"The 8 bytes after the id and flags are the 4 counters represented as u16s."),"\n",r.createElement(t.pre,null,r.createElement(t.code,null,"0001 0000 0000 0001\n\nQDCOUNT = 1\nANCOUNT = 0\nNSCOUNT = 0\nARCOUNT = 1\n")),"\n",r.createElement(t.p,null,"So our counters show us that there is one ",r.createElement(t.em,null,"question")," and one ",r.createElement(t.em,null,"additional record")," in our message."),"\n",r.createElement(o.Z,null,r.createElement(t.p,null,"ARCount is commonly set to 1 indicating that there is an ",r.createElement(t.em,null,"additional record")," included. DNS has pretty much ",r.createElement(t.em,null,"outgrown")," its header size and there was a need to be able to include more meta information in messages so DNS was extended in ",r.createElement(t.a,{href:"https://datatracker.ietf.org/doc/html/rfc6891"},"rfc 6891")," to include ",r.createElement(t.em,null,"pseudo records")," that is used to include additional meta information in both requests and responses.")),"\n",r.createElement(t.h2,null,"DNS Question section"),"\n",r.createElement(t.p,null,"Lastly in a standard DNS message is the actual query. THis section contains the domain name we are asking for and and the definition of what type of ",r.createElement(t.em,null,"resource records")," we want."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-bash"},"                                    1  1  1  1  1  1\n      0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5\n    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n    |                                               |\n    /                     QNAME                     /\n    /                                               /\n    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n    |                     QTYPE                     |\n    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n    |                     QCLASS                    |\n    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n")),"\n",r.createElement("br"),"\n",r.createElement("br"),"\n",r.createElement(t.h3,null,"QNAME (Question Name)"),"\n",r.createElement(t.p,null,"The first part consists of a domain name which in the specification is called a ",r.createElement(t.em,null,"QNAME")," (question name). This is a dynamically sized field with a max value of 255 bytes. The format of the data is a mixture of numbers and ",r.createElement(t.em,null,"labels")," in the ASCII format, with each ",r.createElement(t.em,null,"label")," of a domain name prefixed by its length."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-bash"},"# format:\n<length><label><length><label><Null>\n\n# example:\n3www6google3com\n")),"\n",r.createElement("br"),"\n",r.createElement("br"),"\n",r.createElement(t.p,null,"So if we convert the data in our message from previous we see the following:"),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-bash"},"# hex values\n04 62 6c 6f 67 0c 74 6f 65 72 6b 74 75 6d 6c 61 72 65 03 63 6f 6d 00\n\n# numeric and ascii values\n 4  b  l  o  g 12  t  o  e  r  k  t  u  m  l  a  r  e  3  c  o  m NULL\n\n# result formatted\n4 blog 12 toerktumlare 3 com NULL\n")),"\n",r.createElement(t.p,null,"As you can see no dots are included, they are substituted by the length value."),"\n",r.createElement("br"),"\n",r.createElement("br"),"\n",r.createElement(o.Z,null,r.createElement(t.p,null,"There are some size limits defined in the RFC. We are only allowed to have ASCII characters in names. Additional restriction include a length limit of 63 octets or less. This limit is actually defined because of how compression in DNS messages is implemented. Additional limits that need to be considered is 255 bytes for a single domain name and 512 bytes which is the maximum size of UDP messages.")),"\n",r.createElement("br"),"\n",r.createElement("br"),"\n",r.createElement("br"),"\n",r.createElement("br"),"\n",r.createElement(t.h3,null,"QTYPE and QCLASS"),"\n",r.createElement(t.p,null,"The last parts of the body section of dns message is the ",r.createElement(t.em,null,"QType")," and ",r.createElement(t.em,null,"QClass"),"."),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-bash"},"      0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5\n    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n    |                     QTYPE                     |\n    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n    |                     QCLASS                    |\n    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+\n")),"\n",r.createElement(t.p,null,"The ",r.createElement(t.em,null,"QType")," value is the more important value of the two. This value defines what kind of record we would like to have returned. Common questions would for instance to ask for an ",r.createElement(t.em,null,"A")," record, or maybe a ",r.createElement(t.em,null,"CNAME")," record. Each record has a defined number, and the ",r.createElement(t.a,{href:"https://datatracker.ietf.org/doc/html/rfc1035#section-3.2.2"},"dns rfc specifies a list")," of type values. Throughout the years, more types have been added for instance the ",r.createElement(t.em,null,"AAAA")," record was added to support ipv6 was ",r.createElement(t.a,{href:"https://datatracker.ietf.org/doc/html/rfc1886"},"first added in December 1995")," and later ",r.createElement(t.a,{href:"https://datatracker.ietf.org/doc/html/rfc3596"},"updated in October 2003"),"."),"\n",r.createElement(t.p,null,"Lastly ",r.createElement(t.em,null,"QClass")," was previously used to define in what type of network the query was made. It only has 4 definitions:"),"\n",r.createElement(t.p,null,"        IN                1 the Internet"),"\n",r.createElement(t.p,null,"        CS                2 the CSNET class (Obsolete - used only for examples in some obsolete RFCs)"),"\n",r.createElement(t.p,null,"        CH                3 the CHAOS class"),"\n",r.createElement(t.p,null,"        HS                4 Hesiod [Dyer 87]"),"\n",r.createElement(t.p,null,"Nowadays most of these definitions are deprecated so in a standard DNS query this value is always set to 1 to represent ",r.createElement(t.em,null,"the internet"),"."),"\n",r.createElement(t.h2,null,"Analysing our full question"),"\n",r.createElement(t.p,null,"So if we do a full breakdown of our request we get the following:"),"\n",r.createElement(t.pre,null,r.createElement(t.code,{className:"language-bash"},'# id\n98ad                                                   # => 39085\n\n# header\n0100                                                   # => b0000_0001 b0000_0000\n                                                       # query    = 0\n                                                       # opcode   = 0\n                                                       # Authoritative Answer = 0\n                                                       # TrunCation = 0\n                                                       # Recursion Desired = 1\n                                                       # Recursion Available = 0\n                                                       # Z = 0\n                                                       # Response Code = 0\n \n\n# qdcount\n0001                                                   # => One question\n\n# ancount\n0000                                                   # => No answer \n\n# nscount\n0000                                                   # => No name server record\n\n# arcount\n0001                                                   # => one additional record \n\n# length\n04                                                     # => 4\n\n# label\n626c 6f67                                              #  => "blog"\n\n#length\n0c                                                     # => 12\n\n# label\n746f 6572 6b74 756d 6c61 7265                          # => "toerktumlare"\n\n# length\n03                                                     # => 3\n\n# label\n636f 6d                                                # => com\n\n# null byte\n00 \n\n# QType\n0001                                                   # => A-record \n\n#QClass\n0001                                                   # => IN (internet)\n\n# OPT resource record (rfc6891)\n0000 2904 d000 0000 0000 0c00 0a00 08e1 57ec abeb 0d51 bd\n')),"\n",r.createElement(t.h2,null,"OPT RR-Record"),"\n",r.createElement(t.p,null,"The last bytes in our DNS message is what is called an ",r.createElement(t.em,null,"optional resource record")," and is an extension that was added to expand on the capabilities of DNS. This feature is OPTIONAL and ",r.createElement(t.code,null,"dig")," uses this feature when doing requests. As it is optional, means that most DNS servers will accept queries without this additional resource record."),"\n",r.createElement(t.h2,null,"Message compression"),"\n",r.createElement(t.p,null,"There is some compression actually built into the DNS format to send smaller\nmessages. And im not going to explain how it works in this blog post but there\nmight be a separate post about it with a code example of how to solve the\ncompression in DNS messages."),"\n",r.createElement(t.h1,null,"Final Thoughts"),"\n",r.createElement(t.p,null,"DNS is a fascinating protocol that is used all over the internet. It has been expanded many times, and you can sense a lot of the ",r.createElement(t.em,null,"old internet")," within the protocol. By breaking down these messages, i managed to learn a lot more about DNS and networking in general."),"\n",r.createElement(t.p,null,"You are welcome to check out my simple implementation of my basic dns client ",r.createElement(t.a,{href:"https://www.github.com/tandolf/who"},"Who are you?")," written in rust."))}var s=function(e){void 0===e&&(e={});var t=Object.assign({},(0,a.ah)(),e.components).wrapper;return t?r.createElement(t,e,r.createElement(i,e)):i(e)},c=n(1082),u=n(7464),d=n(7015),m=n(4001),h=n(1250),f=n(6603),p=function(e){var t,n,a,l,o,i,s,m,p=e.data,g=p.previous,b=p.next,E=p.site,y=p.mdx,w=(e.location,e.children),v=(null==E||null===(t=E.siteMetadata)||void 0===t||t.title,null!=y&&null!==(n=y.frontmatter)&&void 0!==n&&n.tags?y.frontmatter.tags.replaceAll(/\s/g,"").split(","):[]);return r.createElement(d.Z,null,r.createElement("article",{className:"blog-post",itemScope:!0,itemType:"http://schema.org/Article"},r.createElement("header",{style:{marginBottom:30}},r.createElement("h1",{itemProp:"headline"},null==y||null===(a=y.frontmatter)||void 0===a?void 0:a.title),r.createElement(h.v,null,null==y||null===(l=y.frontmatter)||void 0===l?void 0:l.date),r.createElement(f.Z,{tags:v})),r.createElement("section",{itemProp:"articleBody"},w),r.createElement(f.Z,{tags:v}),r.createElement("hr",null),r.createElement("footer",null,r.createElement(u.Z,null))),r.createElement("nav",{className:"blog-post-nav"},r.createElement("ul",{style:{display:"flex",flexWrap:"wrap",justifyContent:"space-between",listStyle:"none",padding:0}},r.createElement("li",null,g&&r.createElement(c.Link,{to:(null==g||null===(o=g.fields)||void 0===o?void 0:o.slug)||"",rel:"prev"},r.createElement(h.u,null,"← ",(null==g||null===(i=g.frontmatter)||void 0===i?void 0:i.title)||""))),r.createElement("li",null,b&&r.createElement(c.Link,{to:(null==b||null===(s=b.fields)||void 0===s?void 0:s.slug)||"",rel:"next"},r.createElement(h.u,null,null==b||null===(m=b.frontmatter)||void 0===m?void 0:m.title," →"))))))},g=function(e){var t,n,a=e.data.mdx;return r.createElement(m.Z,{title:null==a||null===(t=a.frontmatter)||void 0===t?void 0:t.title,description:(null==a||null===(n=a.frontmatter)||void 0===n?void 0:n.description)||(null==a?void 0:a.excerpt)})};function b(e){return r.createElement(p,e,r.createElement(s,e))}},7464:function(e,t,n){var a=n(7294),r=n(1082),l=n(3723);t.Z=function(){var e,t,o=(0,r.useStaticQuery)("1085053114"),i=null===(e=o.site.siteMetadata)||void 0===e?void 0:e.author,s=null===(t=o.site.siteMetadata)||void 0===t?void 0:t.social;return a.createElement("div",{className:"bio"},a.createElement(l.S,{className:"bio-avatar",layout:"fixed",formats:["auto","webp","avif"],src:"../images/selfie.jpg",width:50,height:50,quality:95,alt:"Profile picture",__imageData:n(1077)}),(null==i?void 0:i.name)&&a.createElement("p",null,"Written by ",a.createElement("strong",null,i.name)," ","I dont have twitter but i have"," ",a.createElement("a",{href:"https://www.linkedin.com/in/"+((null==s?void 0:s.linkedin)||"")},"linkedin")," ","and im on"," ",a.createElement("a",{href:"https://stackoverflow.com/users/"+((null==s?void 0:s.stack_overflow)||"")},"stack overflow"),"."))}},4278:function(e,t,n){n.d(t,{$_:function(){return i},JO:function(){return c},VY:function(){return s},h4:function(){return o},oo:function(){return u}});var a=n(7294),r=n(3494),l=(0,r.default)("div").withConfig({displayName:"AttentionBox__StyledWrapper",componentId:"sc-y20oae-0"})(["border-left-width:8px;border-left-style:solid;border-left-color:",";border-radius :5px;background-color:",";display:flex;flex-direction:column;padding:16px 16px 0px 16px;margin-bottom:21px;color:",";div{font-size:",";line-height:1.2em;}em{color:",";}a{text-decoration:underline;color:",";}"],(function(e){return e.borderColor||"var(--primary-color)"}),(function(e){return e.backgroundColor||"var(--secondary-color)"}),(function(e){return e.textColor||"var(--font-color)"}),(function(e){return e.fontSize+"px"||0}),(function(e){return e.textColor||"var(--font-color)"}),(function(e){return e.textColor||"var(--font-color)"})),o=r.default.div.withConfig({displayName:"AttentionBox__Header",componentId:"sc-y20oae-1"})(["display:flex;text-transform:uppercase;font-weight:bolder;margin-bottom:5px;align-items:center;"]),i=r.default.div.withConfig({displayName:"AttentionBox__Footer",componentId:"sc-y20oae-2"})(["display:flex;font-style:italic;font-weight:bolder;align-items:center;justify-content:end;font-size:16px;"]),s=r.default.div.withConfig({displayName:"AttentionBox__Content",componentId:"sc-y20oae-3"})(["code{padding-left:5px;padding-right:5px;background-color:green;}"]),c=r.default.div.withConfig({displayName:"AttentionBox__Icon",componentId:"sc-y20oae-4"})(["margin-right:7px;margin-bottom:0px;"]),u=function(e){var t=e.children,n=e.backgroundColor,r=e.borderColor,o=e.fontSize,i=e.textColor;return a.createElement(l,{borderColor:r,backgroundColor:n,textColor:i,fontSize:o},t)}},3079:function(e,t,n){var a=n(7294),r=n(3201),l=n(4278);t.Z=function(e){var t=e.children,n=e.source;return a.createElement(l.oo,{fontSize:22,backgroundColor:"transparent"},a.createElement(l.h4,null,a.createElement(l.JO,null,a.createElement(r.fkU,{size:35,style:{verticalAlign:"middle"}}))),a.createElement(l.VY,null,t),n?a.createElement(l.$_,null,n):null)}},1862:function(e,t,n){var a=n(7294),r=n(1279),l=n(4278);t.Z=function(e){var t=e.children;return a.createElement(l.oo,{backgroundColor:"var(--warning-color)",borderColor:"var(--dark-warning-color)",textColor:"var(--font-dark-color)"},a.createElement(l.h4,null,a.createElement(l.JO,null,a.createElement(r.SR5,{size:25,style:{verticalAlign:"middle"}})),"warning"),a.createElement(l.VY,null,t))}},1250:function(e,t,n){n.d(t,{u:function(){return r},v:function(){return l}});var a=n(3494),r=a.default.h3.withConfig({displayName:"styles__LinkText",componentId:"sc-ncn1p3-0"})(["font-size:18px;"]),l=a.default.h3.withConfig({displayName:"styles__DateText",componentId:"sc-ncn1p3-1"})(["font-size:18px;color:var(--color-gray-700);"])},1077:function(e){e.exports=JSON.parse('{"layout":"fixed","backgroundColor":"#181818","images":{"fallback":{"src":"/static/688f707e139e1c5b3b1adc848f4464fb/d24ee/selfie.jpg","srcSet":"/static/688f707e139e1c5b3b1adc848f4464fb/d24ee/selfie.jpg 50w,\\n/static/688f707e139e1c5b3b1adc848f4464fb/64618/selfie.jpg 100w","sizes":"50px"},"sources":[{"srcSet":"/static/688f707e139e1c5b3b1adc848f4464fb/d4bf4/selfie.avif 50w,\\n/static/688f707e139e1c5b3b1adc848f4464fb/ee81f/selfie.avif 100w","type":"image/avif","sizes":"50px"},{"srcSet":"/static/688f707e139e1c5b3b1adc848f4464fb/3faea/selfie.webp 50w,\\n/static/688f707e139e1c5b3b1adc848f4464fb/6a679/selfie.webp 100w","type":"image/webp","sizes":"50px"}]},"width":50,"height":50}')}}]);
//# sourceMappingURL=component---src-templates-blog-post-tsx-content-file-path-home-thomas-documents-code-js-blog-content-blog-anatomy-of-dns-index-mdx-0979d3b4f78a5bb3a002.js.map